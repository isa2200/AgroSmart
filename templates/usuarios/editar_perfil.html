{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block title %}Editar Perfil - AgroSmart{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'usuarios/css/perfil.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
{% endblock %}
{% block content %}
<div class="page-wrap">
  <div class="container profile-container">

    <div class="form-layout">
      <div class="card-neutral preview-card">
        <div class="card-section">
          <h6 class="section-title">Perfil</h6>
          <!-- Vista previa de avatar -->
          <div class="d-flex align-items-center gap-3">
            <div id="avatarPreview" class="avatar-xl d-flex align-items-center justify-content-center">
              {% if form.instance.foto %}
                <img src="{{ form.instance.foto.url }}" alt="Foto de perfil" class="avatar-xl" style="border:none;">
              {% else %}
                <span class="text-muted" style="font-weight:600;">
                  {{ request.user.first_name|default:request.user.username|slice:":1"|upper }}
                </span>
              {% endif %}
            </div>
            <div class="preview-note">Selecciona una nueva foto para actualizar la vista previa.</div>
          </div>
        </div>
        <div class="card-section">
          <div class="section-title">Acciones</div>
          <div class="actions">
            <a href="{% url 'usuarios:perfil' %}" class="btn btn-outline-secondary">
              <i class="fas fa-arrow-left"></i> Volver a Mi Perfil
            </a>
          </div>
        </div>
      </div>

      <div class="card-neutral">
        <div class="card-section">
          <h6 class="section-title">Editar informaci√≥n</h6>
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form|crispy }}
            <div class="mt-3 d-flex gap-2 justify-content-end">
              <a href="{% url 'usuarios:perfil' %}" class="btn btn-outline-secondary">Cancelar</a>
              <button type="submit" class="btn btn-neutral">
                <i class="fas fa-save"></i> Guardar cambios
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const fotoInput = document.getElementById('id_foto');
  const preview = document.getElementById('avatarPreview');
  if (fotoInput) {
    fotoInput.addEventListener('change', function() {
      const file = this.files && this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.innerHTML = '';
        const img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'avatar-xl';
        img.style.border = 'none';
        preview.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  }
});
</script>
{% endblock %}