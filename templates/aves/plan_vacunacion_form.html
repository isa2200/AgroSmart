{% extends 'aves/base.html' %}
{% load widget_tweaks %}

{% block title %}Nuevo Plan de Vacunación - AgroSmart{% endblock %}

{% block page_title %}Nuevo Plan de Vacunación{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'aves:plan_vacunacion_list' %}">Vacunación</a></li>
    {% if user.perfilusuario and user.perfilusuario.rol == 'superusuario' or user.perfilusuario and user.perfilusuario.rol == 'veterinario' %}
    <li class="breadcrumb-item active">Nuevo Plan</li>
    {% endif %}
{% endblock %}

{% block page_actions %}
    <a href="{% url 'aves:plan_vacunacion_list' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i>Volver
    </a>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                {% if user.perfilusuario and user.perfilusuario.rol == 'superusuario' or user.perfilusuario and user.perfilusuario.rol == 'veterinario' %}
                <h5 class="mb-0"><i class="fas fa-syringe me-2"></i>Crear Plan de Vacunación</h5>
                {% endif %}
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.lote.id_for_label }}" class="form-label">Lote *</label>
                                {{ form.lote|add_class:"form-select" }}
                                {% if form.lote.errors %}
                                    <div class="text-danger small">{{ form.lote.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.tipo_vacuna.id_for_label }}" class="form-label">Tipo de Vacuna *</label>
                                {{ form.tipo_vacuna|add_class:"form-select" }}
                                {% if form.tipo_vacuna.errors %}
                                    <div class="text-danger small">{{ form.tipo_vacuna.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.fecha_programada.id_for_label }}" class="form-label">Fecha Programada *</label>
                                {{ form.fecha_programada|add_class:"form-control" }}
                                {% if form.fecha_programada.errors %}
                                    <div class="text-danger small">{{ form.fecha_programada.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dosis_por_ave" class="form-label">Dosis por Ave (ml)</label>
                                <input type="text" id="dosis_por_ave" class="form-control" readonly placeholder="Seleccione una vacuna">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información adicional de la vacuna -->
                    <div id="info_vacuna" class="alert alert-info" style="display: none;">
                        <h6><i class="fas fa-info-circle me-2"></i>Información de la Vacuna</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small><strong>Laboratorio:</strong> <span id="laboratorio_vacuna">-</span></small><br>
                                <small><strong>Vía de aplicación:</strong> <span id="via_aplicacion">-</span></small>
                            </div>
                            <div class="col-md-6">
                                <small><strong>Previene:</strong> <span id="enfermedad_previene">-</span></small><br>
                                <small><strong>Intervalo entre dosis:</strong> <span id="intervalo_dias">-</span> días</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.lote_vacuna.id_for_label }}" class="form-label">Lote de Vacuna</label>
                                {{ form.lote_vacuna|add_class:"form-control" }}
                                {% if form.lote_vacuna.errors %}
                                    <div class="text-danger small">{{ form.lote_vacuna.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.numero_aves_vacunadas.id_for_label }}" class="form-label">Número de Aves a Vacunar</label>
                                {{ form.numero_aves_vacunadas|add_class:"form-control" }}
                                {% if form.numero_aves_vacunadas.errors %}
                                    <div class="text-danger small">{{ form.numero_aves_vacunadas.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.observaciones.id_for_label }}" class="form-label">Observaciones</label>
                        {{ form.observaciones|add_class:"form-control" }}
                        {% if form.observaciones.errors %}
                            <div class="text-danger small">{{ form.observaciones.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'aves:plan_vacunacion_list' %}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Guardar Plan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const vacunasData = {{ vacunas_data|safe }};
    const tipoVacunaSelect = document.getElementById('{{ form.tipo_vacuna.id_for_label }}');
    const dosisInput = document.getElementById('dosis_por_ave');
    const infoVacuna = document.getElementById('info_vacuna');
    const laboratorioSpan = document.getElementById('laboratorio_vacuna');
    const viaAplicacionSpan = document.getElementById('via_aplicacion');
    const enfermedadPrevieneSpan = document.getElementById('enfermedad_previene');
    const intervaloDiasSpan = document.getElementById('intervalo_dias');
    
    tipoVacunaSelect.addEventListener('change', function() {
        const vacunaId = this.value;
        
        if (vacunaId && vacunasData[vacunaId]) {
            const vacuna = vacunasData[vacunaId];
            
            // Actualizar dosis
            dosisInput.value = vacuna.dosis_por_ave + ' ml';
            
            // Actualizar información adicional
            laboratorioSpan.textContent = vacuna.laboratorio;
            viaAplicacionSpan.textContent = vacuna.via_aplicacion;
            enfermedadPrevieneSpan.textContent = vacuna.enfermedad_previene;
            intervaloDiasSpan.textContent = vacuna.intervalo_dias || 'No especificado';
            
            // Mostrar información
            infoVacuna.style.display = 'block';
        } else {
            // Limpiar campos
            dosisInput.value = '';
            dosisInput.placeholder = 'Seleccione una vacuna';
            infoVacuna.style.display = 'none';
        }
    });
});
</script>
{% endblock %}